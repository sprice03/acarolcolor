---
title: "Data download and post-python prep"
format: html
editor: visual
---

```{r}
library(rinat)
library(lubridate)
library(readr)
library(dplyr)
library(tidyr)
library(anytime)
```

Get observations from iNaturalist for each county using its place_ID. These can be found at the end of the URL when searching that county. Alternatively, there is a csv with all place_IDs that you can find here: <https://www.inaturalist.org/pages/developers>

```{r}

#run for each county you want data from

resultscounty = get_inat_obs(
  taxon_name = "Anolis carolinensis",
  place_id = ####,
  quality = "research",
  maxresults = 10000
)
```

Before continuing, make a bigcrittercolor folder for each county in Python. Then, download images to the all_images subfolder.

```{r}
write.csv(resultscounty, "E://a_carol_data/county/county_list.csv")

download_images <- function(dat,size="medium",outpath="E://a_carol_data/county/all_images/"){
  for (i in 1:dim(dat)[1]){
    iurl <- dat$image_url[i]
    iurl <- gsub("medium",size,iurl)
    iname <- paste(outpath,dat$id[i]," ",dat$scientific_name[i]," ",dat$observed_on[i],".jpg",sep="")
    print(iname)
    tryCatch(
      {download.file(iurl,iname, mode = 'wb')},
      error = function(err) {print(paste("MY_ERROR:  ",err))}
    )
    Sys.sleep(2)
  }
}

#run function for each county, may take a while for large counties

download_images(resultscounty, outpath="E://a_carol_data/county/all_images")

```

From here, you can proceed with the computer vision pipeline in Python. Once that is completed, you should get a csv file for each county. Import that and merge with original results to add metadata to color output results.

```{r}
#merge data with color output from pipeline for each county
county_colorout <- merge(county_list, county_colorout, by = 'id', all.y = TRUE )
county_colorout$county <- "county"
```

Merge all counties you obtained data for to create a final data set, then add the necessary information for temperature analysis and modeling.

```{r}
#merge all counties for a final, labeled data set
finaldata <- rbind(travis_colorout, richland_colorout, fulton_colorout, harris_colorout, hillsborough_colorout, 
                   alachua_colorout, horry_colorout, jefferson_colorout, leon_colorout, mecklenburg_colorout,
                   miamidade_colorout, newhanover_colorout, nueces_colorout, orange_colorout, orleans_colorout,
                   dallas_colorout, chatham_colorout, wake_colorout, bexar_colorout, broward_colorout)

#add time information based on observation date
finaldata$weeks <- week(ymd(finaldatat$observed_on))
finaldata$yday <- yday(finaldata$observed_on)
finaldata$year <- year(finaldata$observed_on)

#create binary color ID
finaldata <- finaldata %>%
  mutate(colorid = if_else(color == "green", 1, 0))

```

From here, you are ready to obtain temperature data for each observation
